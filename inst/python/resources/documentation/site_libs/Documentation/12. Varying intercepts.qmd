# Varying intercepts
## General Principles
To model the relationship between predictor variables and an independent variable while allowing for different intercepts across groups or clusters, we can use a _Varying Intercepts_ model. This approach is particularly useful when data is grouped (e.g., by subject, location, or time period) and we expect the baseline level of the outcome to vary across these groups.

## Considerations
::: callout-caution 
- We have the same considerations as for [Regression for continuous variable](1.&#32;Linear&#32;Regression&#32;for&#32;continuous&#32;variable.qmd).

- The main idea of varying intercepts is to generate an intercept for each group, allowing each group to start at different levels. Thus, the intercept $\beta$ is defined based on the $k$ declared groups.
  
- Each intercept have is own _Normal distribution_ -i.e. a [<span style="color:#0D6EFD">hyper-prior ðŸ›ˆ</span>]{#hyperP}

-In the code below, the _hyper-prior_ is ```a_bar```.
:::

## Example

Below is an example code snippet demonstrating Bayesian regression with varying intercepts using the Bayesian Inference (BI) package:

::: {.panel-tabset group="language"}
## Python
```python
from main import*

# Setup device------------------------------------------------
m = bi(platform='cpu')

# Import data ------------------------------------------------
m.data('../data/reedfrogs.csv', sep=';') 
m.df["tank"] = np.arange(m.df.shape[0])
tank = jnp.array(m.df["tank"].astype('int32').values)
density = jnp.array(m.df["density"].astype('float32').values)
surv = jnp.array(m.df["surv"].astype('int32').values)
m.data_on_model = dict(
    tank = tank,
    surv = surv
)

# Define model ------------------------------------------------
def model(tank, surv):
    sigma = dist.exponential( 1,  name = 'sigma')
    a_bar = dist.normal( 0., 1.5, name = 'a_bar')
    alpha = dist.normal( a_bar, sigma, shape= [48], name = 'alpha')
    p = jnp.squeeze(alpha[tank])
    lk("y", Binomial(total_count = density, logits = p), obs=surv)

# Run mcmc ------------------------------------------------
m.run(model) 

# Summary ------------------------------------------------
m.sampler.print_summary(0.89)
```
## R

```R
library(reticulate)
bi <- import("main")

# Setup device ------------------------------------------------
m = bi$bi(platform='cpu')

# Import data ------------------------------------------------
m$data('../data/reedfrogs.csv', sep=';') 
m$df$tank = c(0:(nrow(m$df)-1))
m$data_to_model(list('tank', 'surv', 'density'))
m$data_on_model$tank = m$data_on_model$tank$astype(bi$jnp$int32)
m$data_on_model$surv = m$data_on_model$surv$astype(bi$jnp$int32)
# Define model ------------------------------------------------
model <- function(tank, surv, density){
  sigma = bi$dist$exponential( 1,  name = 'sigma')
  a_bar = bi$dist$normal(0, 1.5, name='a_bar')
  alpha = bi$dist$normal(a_bar, sigma, name='alpha', shape = tuple(as.integer(48)))
  p = alpha[tank]
  bi$lk("y", bi$Binomial(total_count = density, logits = p), obs=surv)
}

# Run MCMC ------------------------------------------------
m$run(model) 

# Summary ------------------------------------------------
m$sampler$print_summary(0.89)
```
:::

## Mathematical Details
### *Formula*
We model the relationship between the independent variables _X_ and the outcome variable _Y_ with varying intercepts $\alpha$ for each group _k_ using the following equation:

$$
Y_{ik} = \alpha_k + \beta X_{ik} + \sigma
$$

Where:

- $Y_{ik}$ is the outcome variable for observation _i_ in group _k_.
  
- $\alpha_k$ is the varying intercept for group _k_.
  
- $X_{ik}$ is the independent variables for observation _i_ in group _k_.
  
- $\beta$ is the regression coefficients term.
  
- $\sigma$ is the error term, typically assumed to be normally distributed and positive.

### *Bayesian model*
We can express the Bayesian regression model accounting for prior distribution as follows:

$$
Y_{ik} = Normal(\mu_{ik}, \sigma)
$$
$$
\mu_{ik} = \alpha_j + \beta X_{ik} + \sigma 
$$
$$
\alpha_k \sim \text{Normal}(\mu_{\alpha_k}, \sigma_{\alpha_k}) 
$$
$$
\beta \sim \text{Normal}(0, 1)
$$
$$
\sigma \sim \text{Exponential}(1)
$$
$$
\mu_{\alpha_k} \sim \text{Normal}(0, 1)
$$
$$
\sigma_{\alpha_k} \sim \text{Exponential}(1)
$$

Where:

- $Y_{ij}$ is the likelihood function for the outcome variable.
  
- $\alpha_k$ is the varying intercepts across groups.
  
- $\mu_{\alpha_k}$ is the overall mean intercept.
  
- $\sigma_{\alpha_k}$ is the variance of the intercepts across groups.
  
- $\beta$ is the prior distributions for the regression coefficients.
  
- $\sigma$ is the prior distributions for the error term.
  

## Notes
::: callout-note 
- We can apply multiple variables similarly as [chapter 2](/2.&#32;Multiple&#32;Regression&#32;for&#32;Continuous&#32;Variables.qmd).

- We can apply interaction terms  similarly as [chapter 3](\3.&#32;Interaction&#32;between&#32;continuous&#32;variables.qmd).

- We can apply  caterogical variables similarly as [chapter 4](4.&#32;Categorical&#32;variable.qmd). 

- We can apply  varying intercepts with any distribution developped in previous chapters. 
:::

## Reference(s)
@mcelreath2018statistical
